env:
  global:
    - NODE_VERSION=10
    - ADB_INSTALL_TIMEOUT=8
    # - ANDROID_HOME=/usr/local/android-sdk
    # - ANDROID_SDK_ROOT=/usr/local/android-sdk
    # - TOOLS=${ANDROID_HOME}/tools
    # - PATH=${ANDROID_HOME}:${ANDROID_HOME}/emulator:${TOOLS}:${TOOLS}/bin:${ANDROID_HOME}/platform-tools:${PATH}

stages:
  - name: test/travis-ci

jobs:
  include:
    - stage: test/travis-ci
      language: android
      cache: npm
      android:
        components:
          - tools
          - platform-tools
          - tools
          - build-tools-28.0.3
          - android-28
          - extra-google-m2repository
          - extra-android-m2repository
          - sys-img-x86-android-28
      licenses:
        - 'android-sdk-license-.+'
        - 'android-sdk-preview-license-.+'
        - 'google-gdk-license-.+'
      before_install:
        - yes | sdkmanager "build-tools;28.0.3" >/dev/null 2>&1
        - yes | sdkmanager "platforms;android-28" >/dev/null 2>&1
      install:
        - wget https://raw.githubusercontent.com/creationix/nvm/v0.31.0/nvm.sh -O ~/.nvm/nvm.sh
        - source ~/.nvm/nvm.sh
        - nvm install $NODE_VERSION
        - nvm use $NODE_VERSION
        - nvm alias default $NODE_VERSION
        - npm install -g react-native-cli >/dev/null 2>&1
        - npm install -g detox-cli >/dev/null 2>&1
        - npm install >/dev/null 2>&1
      before_script:
        - echo no | android create avd --force -n test -t android-28 --abi default/x86
        - emulator -avd test -no-audio -no-window &
        # - android-wait-for-emulator
        - adb shell input keyevent 82 &
      script:
        # - echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p
        - npx detox build -c android.emu.codemagic:release -l verbose
        - npx detox test -c android.emu.codemagic:release -l verbose
